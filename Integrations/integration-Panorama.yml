commonfields:
  id: Panorama
  version: -1
name: Panorama
display: Palo Alto Panorama
fromversion: 3.0.0
category: Network Security
image: data:image/png;base64,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
description: Manage Palo Alto Networks firewalls via the Panorama management interface
detaileddescription: |-
  The integration uses the Panorama XML API.
  To obtain an API Key, use the following REST command:
  https://[PanoramaIP]/api/?type=keygen&user=[user]&password=[password]
  and copy the resulting key.
  For more information, visit: https://www.paloaltonetworks.com/documentation
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Port
  name: port
  defaultvalue: ""
  type: 0
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Device group
  name: device_group
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    ''' IMPORTS '''
    import string
    import requests
    import json
    import re
    import uuid
    import time

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    if not demisto.params().get("proxy", False):
        del os.environ["HTTP_PROXY"]
        del os.environ["HTTPS_PROXY"]
        del os.environ["http_proxy"]
        del os.environ["https_proxy"]

    ''' GLOBALS '''
    URL = demisto.params()['server'].rstrip('/:') + ':' + demisto.params().get('port') + '/api/'
    API_KEY = str(demisto.params()['key']);
    USE_SSL = not demisto.params()['insecure']
    #HEADERS = {'Content-Type': 'application/x-www-form-urlencoded'}

    #setting xpath relevant to FW or panorama managment
    DEVICE_GROUP = demisto.params()['device_group'] if 'device_group' in demisto.params() else None
    XPATH = None
    if DEVICE_GROUP:
        XPATH = "/config/devices/entry/device-group/entry[@name=\'" + DEVICE_GROUP + "\']/post-rulebase/security/rules/entry"
    else:
        XPATH = "/config/devices/entry/vsys/entry/rulebase/security/rules/entry"

    ''' HELPERS '''
    def http_request(uri, method, headers = {}, body = {}, params={}, files = None):
        ''' Makes an API call with the gicen arguments '''
        result = requests.request(
            method,
            uri,
            headers=headers,
            data=body,
            verify=USE_SSL,
            params=params,
            files=files
        )
        if result.status_code < 200 or result.status_code >= 300:
            return_error('Request Failed.\nStatus code: ' + str(result.status_code) + ' with body ' + result.content + ' with headers ' + str(result.headers))

        jresult = json.loads(xml2json(result.text))
        if jresult['response']['@status'] != 'success':
            if '@code' in jresult['response']:
                return_error('Request Failed.\nStatus code: ' + jresult['response']['@code'] + '\nWith message: ' + jresult['response']['msg']['line'])
            elif '@status' in jresult['response']:
                return_error('Request Failed.\nStatus: ' + jresult['response']['@status'] + '\nWith message: ' + jresult['response']['msg']['line'])
            else:
                return_error('Request Failed.\n' + jresult['response'])

        return jresult

    def add_argument(arg, field_name, member):
        if arg:
            if member:
                return '<' + field_name + '><member>' + arg + '</member></' + field_name + '>'
            else:
                return '<' + field_name + '>' + arg + '</' + field_name + '>'
        else:
            return ''
    def add_argument_open(arg, field_name, member):
        if arg:
            if member:
                return '<' + field_name + '><member>' + arg + '</member></' + field_name + '>'
            else:
                return '<' + field_name + '>' + arg + '</' + field_name + '>'
        else:
            if member:
                return '<' + field_name + '><member>any</member></' + field_name + '>'
            else:
                return '<' + field_name + '>any</' + field_name + '>'

    def add_argument_yes_no(arg, field_name):
        if (arg and arg == 'No'):
            return '<' + field_name + '>' + 'no' + '</' + field_name + '>'
        else:
            return '<' + field_name + '>' + ('yes' if arg else 'no') + '</' + field_name + '>'

    def prepare_params(xpath = None, rulename = None, src_ip = None, dst_ip = None,
                    negate_src = None, negate_dst = None, action = None, service = None,
                    disable = None, application = None, src_user = None,
                    fromm = None, to = None, disable_server_response_inspection = None,
                    description = None):

        rulename = rulename if rulename else uuid.uuid4()
        params = {
            'type': 'config',
            'action': 'set',
            'key': API_KEY,
            'xpath': xpath if xpath else XPATH +  "[@name=\'" + rulename + "\']",
            'element': add_argument_open(action, 'action', False) +
                add_argument_open(description, 'description', False) +
                add_argument_open(src_ip, 'source', True) +
                add_argument_open(dst_ip, 'destination', True) +
                add_argument_open(application, 'application', True) +
                add_argument_open(src_user, 'source-user', True) +
                add_argument_open(fromm, 'from', True) +
                add_argument_open(to, 'to', True) +
                add_argument_open(service, 'service', True) +
                add_argument_yes_no(negate_src, 'negate-source') +
                add_argument_yes_no(negate_dst, 'negate-destination') +
                add_argument_yes_no(disable, 'disabled')
        }
        return params

    ''' FUNCTIONS'''
    def panorama_test():
        ''' test module '''
        params = {
            'type':'op',
            'cmd': '<show><system><info></info></system></show>',
            'key': API_KEY
            }
        result = http_request(
            URL,
            'GET',
            params = params
            )
        demisto.results('ok')

    def prettify_address_group(address_group):
        pretty_address_group = {
            'Name': address_group['@name'],
            'Type': 'static' if 'static'in address_group else 'dynamic',
        }

        if 'description' in address_group:
            pretty_address_group['Description'] = address_group['description']

        if 'tag' in address_group:
            pretty_address_group['Tag'] = address_group['tag']['member']

        if pretty_address_group['Type'] == 'static':
            pretty_address_group['Member'] = address_group['static']['member']
        else:
            pretty_address_group['Filter'] = address_group['dynamic']['filter']

        return pretty_address_group

    def panorama_get_address_group():
        ''' Gets configured address groups '''
        params = {
            'action': 'show',
            'type': 'config',
            'xpath': "/config/devices/entry/vsys/entry/address-group/entry[@name='" + demisto.args()['address_group'] + "']",
            'key': API_KEY
        }
        result = http_request(
                URL,
                'GET',
                params = params,
                )

        result = result['response']['result']['entry']

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Address group:', prettify_address_group(result), ['Name', 'Type', 'Tag', 'Member', 'Filter', 'Description'], None, True),
            'EntryContext': {
                  "PanoramaAddressGroups(val.Name == obj.Name)": prettify_address_group(result)
            }
        })

    def prettify_address_groups_arr(address_groups_arr):
        pretty_address_groups_arr = []
        for i in range (len(address_groups_arr)):
            address_group = address_groups_arr[i]
            pretty_address_group = {
                'Name': address_group['@name'],
                'Type': 'static' if 'static'in address_group else 'dynamic',
            }
            if 'description' in address_group:
                pretty_address_group['Description'] = address_group['description']

            if 'tag' in address_group:
                pretty_address_group['Tag'] = address_group['tag']['member']

            if pretty_address_group['Type'] == 'static':
                pretty_address_group['Member'] = address_group['static']['member']
            else:
                pretty_address_group['Filter'] = address_group['dynamic']['filter']
            pretty_address_groups_arr.append(pretty_address_group)
        return pretty_address_groups_arr;

    def panorama_get_address_groups():
        ''' Gets all address groups configuration '''
        params = {
            'action': 'get',
            'type': 'config',
            'xpath': "/config/devices/entry/vsys/entry/address-group/entry",
            'key': API_KEY
        }
        result = http_request(
                URL,
                'GET',
                params = params,
                )

        result = result['response']['result']
        address_groups_arr = result['entry']

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Address groups:', prettify_address_groups_arr(address_groups_arr), ['Name', 'Type', 'Tag', 'Member', 'Filter', 'Description'], None, True),
            'EntryContext': {
                  "PanoramaAddressGroups(val.Name == obj.Name)": prettify_address_groups_arr(address_groups_arr)
            }
        })

    def panorama_edit_dynamic_address_group():
        ''' Edit an address group '''
        address_group_name = demisto.args()['name']

        filterr = demisto.args()['filter'] if 'filter' in demisto.args() else None
        filterr_param = add_argument_open(filterr, 'filter', False)
        filterr_path = "/config/devices/entry/vsys/entry/address-group/entry[@name='" + address_group_name + "']/dynamic/filter",

        tag = demisto.args()['tag'] if 'tag' in demisto.args() else None
        tag_param = add_argument_open(tag, 'tag', True)
        tag_path = "/config/devices/entry/vsys/entry/address-group/entry[@name='" + address_group_name + "']/tag",

        description = demisto.args()['description'] if 'description' in demisto.args() else None
        description_param = add_argument_open(description, 'description', False)
        description_path = "/config/devices/entry/vsys/entry/address-group/entry[@name='" + address_group_name + "']/description",

        params = {
            'action': 'edit',
            'type': 'config',
            'key': API_KEY,
        }

        ec = {'Name': address_group_name}

        if (filterr):
            params['xpath'] = filterr_path
            params['element'] = filterr_param
            result = http_request(URL, 'POST', params = params)
            ec['Filter'] = filterr
        if (tag):
            params['xpath'] = tag_path
            params['element'] = tag_param
            result = http_request(URL, 'POST', params = params)
            ec['tag'] = tag
        if (description):
            params['xpath'] = description_path
            params['element'] = description_param
            result = http_request(URL, 'POST', params = params)
            ec['description'] = description

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Panorama address group was editted successfully',
            'EntryContext': {
                  "PanoramaAddressGroups(val.Name == obj.Name)": ec
            }
        })

    def panorama_create_dynamic_address_group():
        ''' Create a dynamic address group '''
        address_group_name = demisto.args()['name']
        filterr = demisto.args()['filter'] if 'filter' in demisto.args() else None
        description = demisto.args()['description'] if 'description' in demisto.args() else None
        tag = demisto.args()['tag'] if 'tag' in demisto.args() else None

        params = {
            'action': 'edit',
            'type': 'config',
            'xpath': "/config/devices/entry/vsys/entry/address-group/entry[@name='" + address_group_name + "']",
            'key': API_KEY
        }
        params['element'] = "<entry name='" + address_group_name + "'>" + "<dynamic>" + add_argument(filterr, 'filter', False) + "</dynamic>" + add_argument(description, 'description', False) + add_argument(tag, 'tag', True) + "</entry>"
        result = http_request(
                URL,
                'POST',
                params = params,
                )

        ec = {
            'Name': address_group_name,
            'Type': 'dynamic'
        }
        if filterr:
            ec['Filter'] = filterr
        if tag:
            ec['tag'] = tag
        if description:
            ec['description'] = description

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Dynamic address group was created successfully',
            'EntryContext': {
                  "PanoramaAddressGroups(val.Name == obj.Name)": ec
            }
        })

    def panorama_delete_address_group():
        ''' Delete an address group '''
        address_group_name = demisto.args()['name']

        params = {
            'action': 'delete',
            'type': 'config',
            'xpath': "/config/devices/entry/vsys/entry/address-group/entry[@name='" + address_group_name + "']",
            'key': API_KEY
        }
        params['element'] = "<entry name='" + address_group_name + "'></entry>"

        result = http_request(
                URL,
                'POST',
                params = params,
                )

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Address group was deleted successfully',
        })

    # ---------------------how to deprecate it? ------------------------
    def panorama_dynamic_list():
        ''' Creates a dynamic list in Panorama '''
        params = {
            'type':'user-id',
            'key': API_KEY
        }

        file_entry_id = demisto.args()['file']
        with open(demisto.getFilePath(file_entry_id)['path'], 'rb') as f:
            demisto.log(str(demisto.getFilePath(file_entry_id)))
            demisto.log(demisto.getFilePath(file_entry_id)['path'])
            demisto.log(str(f))
            demisto.log(str(dir(f)))
            #sys.exit(0)
            result = http_request(
                URL,
                'POST',
                params = params,
                files = f,
                )
        demisto.results(result['response']['@status'])

    def panorama_move():
        ''' Moves a rule in Panorama'''
        params = {
            'type': 'config',
            'action': 'move',
            'key': API_KEY,
            'where': demisto.args()['where']
        }

        if 'xpath' in demisto.args():
            params['xpath'] = demisto.args()['xpath']
        else:
            params['xpath'] = '/config/devices/entry/vsys/entry/rulebase/security/rules/entry[@name=\'' + demisto.args()['src'] + '\']'

        if 'dst' in demiso.args():
            params['dst'] = demisto.args()['dst']

        result = http_request(URL, 'POST', params = params)
        demisto.results(result['response']['@status'])

    def panorama_get_pcaps():
        ''' Get panorama pcaps '''
        params = {
            'type': 'export',
            'key': API_KEY,
            'category': demisto.args()['pcapType']
        }

        if 'password' in demisto.args():
            params['dlp-password'] = demisto.args()['password']
        elif demisto.args()['pcapType'] == 'dlp-pcap':
            return_error('can not provide dlp-pcap without password')

        if 'pcapID' in demisto.args():
            params['pcap-id'] = demisto.args()['pcapID']
        elif demisto.args()['pcapType'] == 'threat-pcap':
            return_error('can not provide threat-pcap without pcap-id')

        fromm = demisto.args()['from'] if 'from' in demisto.args() else None
        to = demisto.args()['to'] if 'to' in demisto.args() else None
        serialno = demisto.args()['serialNo'] if 'serialNo' in demisto.args() else None
        search_time = demisto.args()['searchTime'] if 'searchTime' in demisto.args() else None

        if (fromm):
            params['from'] = fromm
        if (to):
            params['to'] = to
        if (serialno):
            params['serialno'] = serialno
        if (search_time):
            params['search-time'] = search_time

        result = http_request(URL, 'GET', params = params)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Got pcap succesfully',
        })

    def panorama_config():
        ''' Configures a security rule in panorama'''
        xpath = demisto.args()['xpath'] if 'xpath' in demisto.args() else None
        rule_name =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())
        src_ip =  demisto.args()['src_ip'] if 'src_ip' in demisto.args() else None
        dst_ip =  demisto.args()['dst_ip'] if 'dst_ip' in demisto.args() else None
        negate_src =  demisto.args()['negate_src'] if 'negate_src' in demisto.args() else None
        negate_dst =  demisto.args()['negate_dst'] if 'negate_dst' in demisto.args() else None
        action =  demisto.args()['action'] if 'action' in demisto.args() else None
        service =  demisto.args()['service'] if 'service' in demisto.args() else None
        disable =  demisto.args()['disable'] if 'disable' in demisto.args() else None
        application = demisto.args()['application'] if 'application' in demisto.args() else None
        src_user = demisto.args()['src_user'] if 'src_user' in demisto.args() else None
        fromm = demisto.args()['from'] if 'from' in demisto.args() else None
        to = demisto.args()['to'] if 'to' in demisto.args() else None
        disable_server_response_inspection = demisto.args()['disable_server_response_inspection'] if 'disable_server_response_inspection' in demisto.args() else None
        description = demisto.args()['description'] if 'description' in demisto.args() else None

        params = prepare_params(xpath = xpath, rulename = rule_name, src_ip = src_ip, dst_ip = dst_ip,
                    negate_src = negate_src, negate_dst = negate_dst, action = action, service = service,
                    disable = disable, application = application, src_user = src_user,
                    fromm = fromm, to = to, disable_server_response_inspection = disable_server_response_inspection,
                    description = description)
        result = http_request(URL, 'POST', params = params)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Rule configured succesfully',
            #'EntryContext': {
            #      "PanoramaRule(val.Name == obj.Name)": ec
            #}
        })

    def panorama_block_ip():
        ''' Blocks an IP in panorama'''
        ip = demisto.args()['ip']
        direction = demisto.args()['direction'] if 'direction' in demisto.args() else 'both'
        rulename =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())

        block_destination = False if direction == 'from' else True
        block_source =  False if direction == 'to' else True

        if block_source:
            params = prepare_params(action = 'drop', src_ip = ip, dst_ip = 'any', rulename = rulename + '-from')
            result = http_request(URL, 'POST', params = params)

        if block_destination:
            params = prepare_params(action = 'drop', dst_ip = ip, src_ip = 'any', rulename = rulename + '-to')
            result = http_request(URL, 'POST', params = params)

        ec = {
            'IP': ip,
            'Name': rulename,
            'Direction': direction,
            'Disabled': False
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'IP blocked succesfully',
            'EntryContext': {
                  "PanoramaRule(val.Name == obj.Name)": ec
            }
        })

    def panorama_block_address_group():
        ''' Blocks an address group in panorama'''
        address_group_name = demisto.args()['address_group_name']
        direction = demisto.args()['direction'] if 'direction' in demisto.args() else 'both'
        rulename =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())

        block_destination = False if direction == 'from' else True
        block_source =  False if direction == 'to' else True

        if block_source:
            params = prepare_params(action = 'drop', src_ip = address_group_name, dst_ip = 'any', rulename = rulename + '-from')
            result = http_request(URL, 'POST', params = params)

        if block_destination:
            params = prepare_params(action = 'drop', dst_ip = address_group_name, src_ip = 'any', rulename = rulename + '-to')
            result = http_request(URL, 'POST', params = params)

        ec = {
            'AddressGroupName': address_group_name,
            'Name': rulename,
            'Direction': direction,
            'Disabled': False
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Address group blocked succesfully',
            'EntryContext': {
                  "PanoramaRule(val.Name == obj.Name)": ec
            }
        })

    def prettify_applications_arr(applications_arr):
        pretty_application_arr = []
        for i in range (len(applications_arr)):
            application = applications_arr[i]
            pretty_application_arr.append({
                'SubCategory': application['subcategory'],
                'Risk': application['risk'],
                'Technology': application['technology'],
                'Name': application['@name'],
                'Description': application['description'],
                'Id': application['@id']
            })
        return pretty_application_arr;

    def panorama_get_applications():
        ''' Get all applications in panorama'''
        params = {
            'type': 'op',
            'command': '<show><objects></objects></show>',
            'key': API_KEY
        }

        result = http_request(
            URL,
            'POST',
            params = params
            )

        applications_arr = result['response']['result']['config']['shared']['content-preview']['application']['entry']

        md = tableToMarkdown(
            'Panorama Applications',
            prettify_applications_arr(applications_arr),
            ['Name', 'Id', 'Risk', 'Category', 'SubCategory', 'Technology', 'Description']
            )

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': applications_arr,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                  "PanoramaApplications(val.Id == obj.Id)": prettify_applications_arr(applications_arr)
            }
        })

    def panorama_block_application():
        ''' Blocks an application in panorama'''
        application = demisto.args()['application']
        rulename =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())
        params = prepare_params(action = 'drop', src_ip = 'any', dst_ip = 'any', rulename = rulename, application = application)
        result = http_request(
            URL,
            'POST',
            params = params
            )

        ec = {
            'Application': application,
            'Name': rulename,
            'Disabled': False
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Application blocked succesfully',
            'EntryContext': {
                  "PanoramaRule(val.Name == obj.Name)": ec
            }
        })

    def panorama_disable_rule():
        ''' Disables a rule in panorama'''
        rulename =  demisto.args()['rulename']
        params = {
            'type': 'config',
            'action': 'set',
            'key': API_KEY,
            'xpath': XPATH +  "[@name=\'" + rulename + "\']",
            'element': '<disabled>yes</disabled>'
        }
        result = http_request(
            URL,
            'POST',
            params = params
            )
        ec = {
            'Name': rulename,
            'Disabled': True
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'rule disabled succesfully',
            'EntryContext': {
                  "PanoramaRule(val.Name == obj.Name)": ec
            }
        })

    def panorama_enable_rule():
        ''' Enables a rule in panorama'''
        rulename =  demisto.args()['rulename']
        params = {
            'type': 'config',
            'action': 'set',
            'key': API_KEY,
            'xpath': XPATH +  "[@name=\'" + rulename + "\']",
            'element': '<disabled>no</disabled>'
        }
        result = http_request(
            URL,
            'POST',
            params = params
            )

        ec = {
            'Name': rulename,
            'Disabled': False
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'rule enabled succesfully',
            'EntryContext': {
                  "PanoramaRule(val.Name == obj.Name)": ec
            }
        })

    def panorama_command():
        ''' Executes a command in panorama'''
        params = {}
        params['key'] = API_KEY
        for arg in demisto.args().keys():
            params[arg] = demisto.args()[arg]

        result = http_request(
                URL,
                'POST',
                params=params
                )

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': result,
            'ReadableContentsFormat': formats['text'],
            'HumanReadable': 'Panorama command was executed successfully',
        })

    def panorama_commit():
        params = {
            'type': 'commit',
            'cmd': '<commit></commit>',
            'key': API_KEY
        }

        result = http_request(
            URL,
            'POST',
            params = params
            )

        #a few seconds until commit will take place
        time.sleep(3)

    def panorama_final_commit():
        ''' Commit panorama '''
        params = {
            'type': 'commit',
            'cmd': '<commit></commit>',
            'key': API_KEY
        }

        result = http_request(
            URL,
            'POST',
            params = params
            )

        if ('result' in result['response']):
            return_error('Panorama commit failed.')
        else:
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': result,
                'ReadableContentsFormat': formats['text'],
                'HumanReadable': 'Panorama was committed successfully',
            })

    ''' EXECUTION '''
    LOG('command is %s' % (demisto.command(), ))

    try:
        if demisto.command() == 'test-module':
            panorama_test()

        elif demisto.command() == 'panorama-get-address-group':
            panorama_get_address_group()

        elif demisto.command() == 'panorama-get-address-groups':
            panorama_get_address_groups()

        elif demisto.command() == 'panorama-edit-dynamic-address-group':
            panorama_edit_dynamic_address_group()
            panorama_commit()

        elif demisto.command() == 'panorama-create-dynamic-address-group':
            panorama_create_dynamic_address_group()
            panorama_commit()

        elif demisto.command() == 'panorama-delete-address-group':
            panorama_delete_address_group()
            panorama_commit()

        elif demisto.command() == 'panorama-dynamic-block-list':
            panorama_dynamic_list()

        elif demisto.command() == 'panorama-move':
            panorama_move()
            panorama_commit()

        elif demisto.command() == 'panorama-get-pcaps':
            panorama_get_pcaps()

        elif demisto.command() == 'panorama-config':
            panorama_config()
            panorama_commit()

        elif demisto.command() == 'panorama-block-ip':
            panorama_block_ip()
            panorama_commit()

        elif demisto.command() == 'panorama-block-address-group':
            panorama_block_address_group()
            panorama_commit()

        elif demisto.command() == 'panorama-get-applications':
            panorama_get_applications()

        elif demisto.command() == 'panorama-block-application':
            panorama_block_application()
            panorama_commit()

        elif demisto.command() == 'panorama-disable-rule':
            panorama_disable_rule()
            panorama_commit()

        elif demisto.command() == 'panorama-enable-rule':
            panorama_enable_rule()
            panorama_commit()

        elif demisto.command() == 'panorama-commit':
            panorama_commit()

        elif demisto.command() == 'panorama':
            panorama_command()
            panorama_commit()


    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        return_error(e.message)

    panorama_final_commit()
  type: python
  commands:
  - name: panorama
    arguments:
    - name: action
      auto: PREDEFINED
      predefined:
      - set
      - edit
      - delete
      - rename
      - clone
      - move
      - override
      - muti-move
      - multi-clone
      - complete
      - show
      - get
      description: Choose an available  actio(show,get,set,edit, delete,rename,clone,move,override)
    - name: category
      description: Category parameter. e.g. when exporting a configuration file use
        category=configuration
    - name: cmd
      description: Used for operations commands cmd specifies the xml struct that
        defines the command.
    - name: command
      description: Run a command. e.g. command =<show><arp><entry name='all'/></arp></show>
    - name: dst
      description: Specifies destination
    - name: element
      description: Used to define a new value for an object
    - name: to
      description: To parameter (used in specifying time and when cloning an object)
    - name: from
      description: From parameter (used in specifying time and when cloning an object)
    - name: key
      description: Sets a key value
    - name: log-type
      description: Used for retrieving logs. e.g. log-type=threat for threat logs
    - name: where
      description: Specifies the type of a move operation (e.g. where=after, where=before,
        where=top, where=bottom)
    - name: period
      description: Describe a time period. E.g. period=last-24-hrs
    - name: xpath
      description: Defines a location e.g. xpath=/config/predefined/application/entry[@name='hotmail']
    - name: pcap-id
      description: The threat pcap ID in the threat log
    - name: serialno
      description: Specifies the device serial number
    - name: reporttype
      description: Choose dynamic,predefined or custom report
    - name: reportname
      description: The report name
    - name: log-type
      description: Used for retrieving logs. e.g. log-type=threat for threat logs
    - name: type
      description: The request type (e.g. export, import, log, config)
      defaultValue: keygen,config,commit,op,report,log,import,export,user-id,version
    - name: search-time
      description: Used for threat PCAPs, the time that the PCAP was received on the
        firewall.
    description: Run any panorama command supported in api
  - name: panorama-dynamic-block-list
    arguments:
    - name: file
      required: true
      description: The dynamic block list file. Can be created using PanoramaDynamicAddressGroup
        script
    description: Create a dynamic block list
  - name: panorama-move
    arguments:
    - name: xpath
      description: Usually not required as "src" is sufficient. Full XPath to the
        source rule to be moved.
    - name: src
      description: Source value for the request. For further information, see the
        Panorama XML API Documentation.
    - name: where
      required: true
      description: Values for the "where" parameter include "before", "after", "top"
        or "bottom". For further information, see the Panorama XML API Documentation.
    - name: dst
      description: Destination xpath to move the rule. For further information, see
        the Panorama XML API Documentation.
    description: Move panorama rules
  - name: panorama-block-ip
    arguments:
    - name: ip
      required: true
      description: IP to block
    - name: rulename
      description: Rule name
    - name: direction
      description: Direction to block
      defaultValue: to, from, both
    outputs:
    - contextPath: PanoramaRule.Name
      description: Name of the Panorama rule
      type: string
    - contextPath: PanoramaRule.Direction
      description: Direction of the Panorama rule, could be 'to','from', 'both'
      type: string
    - contextPath: PanoramaRule.IP
      description: The IP the Panorama rule blocks
      type: string
    - contextPath: PanoramaRule.Disabled
      description: Status of the rule
      type: string
    description: Blocks IP with Panorama
  - name: panorama-block-application
    arguments:
    - name: application
      required: true
      description: Application to block
    - name: rulename
      description: Rule name
    outputs:
    - contextPath: PanoramaRule.Name
      description: Name of the Panorama rule
      type: string
    - contextPath: PanoramaRule.Application
      description: The Application the Panorama rule blocks
    - contextPath: PanoramaRule.Disabled
      description: Status of the rule
    description: Blocks an application with Panorama
  - name: panorama-disable-rule
    arguments:
    - name: rulename
      required: true
      description: Rule name
    outputs:
    - contextPath: PanoramaRule.Name
      description: Name of the Panorama rule
      type: string
    - contextPath: PanoramaRule.Disabled
      description: Status of the rule
      type: string
    description: Disable a security rule
  - name: panorama-enable-rule
    arguments:
    - name: rulename
      required: true
      description: Rule name
    outputs:
    - contextPath: PanoramaRule.Name
      description: Name of the Panorama rule
    - contextPath: PanoramaRule.Disabled
      description: Status of the rule
    description: Enable a security rule
  - name: panorama-config
    arguments:
    - name: rulename
      description: Name for the rule to be configured
    - name: xpath
      description: Usually not required as rulename is sufficient. Direct XPath to
        the rule entry to be modified.
    - name: src_ip
      description: Source IP address
    - name: dst_ip
      description: Destination IP address
    - name: negate_src
      auto: PREDEFINED
      predefined:
      - "Yes"
      - "No"
      description: Yes/No - whether to negate the source IP address (match all except
        the specified address)
    - name: negate_dst
      auto: PREDEFINED
      predefined:
      - "Yes"
      - "No"
      description: Yes/No - whether to negate the destination IP address (match all
        except the specified address)
    - name: action
      auto: PREDEFINED
      predefined:
      - set
      - edit
      - delete
      - rename
      - clone
      - move
      - override
      - muti-move
      - multi-clone
      - complete
      - show
      - get
      description: Action for the rule
    - name: service
      description: Service for the rule
    - name: disable
      auto: PREDEFINED
      predefined:
      - "Yes"
      - "No"
      description: Yes/No - whether to disable the rule
    - name: application
      description: Application for the rule
    - name: src_user
      description: Source user for the rule
    - name: from
      description: '"From" value for the rule'
    - name: to
      description: '"To" value for the rule'
    - name: description
      description: Rule description
    description: Set panorama configuration
  - name: panorama-get-applications
    arguments: []
    outputs:
    - contextPath: PanoramaApplications.Name
      description: Application name
      type: string
    - contextPath: PanoramaApplications.Id
      description: Application id
      type: number
    - contextPath: PanoramaApplications.Category
      description: Application category
      type: string
    - contextPath: PanoramaApplications.SubCategory
      description: Application sub category
      type: string
    - contextPath: PanoramaApplications.Technology
      description: Application technology
      type: string
    - contextPath: PanoramaApplications.Risk
      description: Application risk (1 to 5)
      type: number
    - contextPath: PanoramaApplications.Description
      description: Application description
      type: string
    description: Get a list of applications
  - name: panorama-get-pcaps
    arguments:
    - name: pcapType
      required: true
      auto: PREDEFINED
      predefined:
      - application-pcap
      - filter-pcap
      - dlp-pcap
      - threat-pcap
      description: Type of Packet Capture
    - name: from
      description: '"From" value for the rule'
    - name: to
      description: '"To" value for the rule'
    - name: serialNo
      description: Serial number for the request. For further information, see the
        Panorama XML API Documentation.
    - name: searchTime
      description: Search time for the request. For further information, see the Panorama
        XML API Documentation.
    - name: pcapID
      description: ' ID of the Pcap for the request. For further information, see
        the Panorama XML API Documentation.'
    - name: password
      description: Password for Panorama
    description: Get panorama pcaps
  - name: panorama-get-address-group
    arguments:
    - name: address_group
      required: true
      description: Address group name
    outputs:
    - contextPath: PanoramaAddressGroups.Name
      description: Address group name
      type: string
    - contextPath: PanoramaAddressGroups.Type
      description: Address group type
      type: string
    - contextPath: PanoramaAddressGroups.Filter
      description: Address group filter
      type: string
    - contextPath: PanoramaAddressGroups.Description
      description: Address group description
      type: string
    - contextPath: PanoramaAddressGroups.Tag
      description: Address group tag
      type: string
    description: Gets address group configuration
  - name: panorama-get-address-groups
    arguments: []
    outputs:
    - contextPath: PanoramaAddressGroups.Name
      description: Address group name
      type: string
    - contextPath: PanoramaAddressGroups.Type
      description: Address group type
    - contextPath: PanoramaAddressGroups.Filter
      description: Address group filter
    - contextPath: PanoramaAddressGroups.Description
      description: Address group description
    - contextPath: PanoramaAddressGroups.Tag
      description: Address group tag
    description: Gets all address groups configuration
  - name: panorama-edit-dynamic-address-group
    arguments:
    - name: name
      required: true
      description: Address group name
    - name: filter
      description: 'Address group new filter. e.g: "1.1.1.1 and 2.2.2.2"'
    - name: description
      description: Address group new description
    - name: tag
      description: Address group new tag
      isArray: true
    outputs:
    - contextPath: PanoramaAddressGroups.Name
      description: Address group name
      type: string
    - contextPath: PanoramaAddressGroups.Type
      description: Address group type
      type: string
    - contextPath: PanoramaAddressGroups.Filter
      description: Address group filter
      type: string
    - contextPath: PanoramaAddressGroups.Description
      description: Address group description
      type: string
    - contextPath: PanoramaAddressGroups.Tag
      description: Address group tag
      type: string
    description: Edit a dynamic address group
  - name: panorama-commit
    arguments: []
    description: Commit Panorama
  - name: panorama-create-dynamic-address-group
    arguments:
    - name: name
      required: true
      description: Address group name
    - name: filter
      required: true
      description: 'Address group filter. e.g: "1.1.1.1 or 2.2.2.2"'
    - name: description
      description: Address group description
    - name: tag
      description: Address group tag
    outputs:
    - contextPath: PanoramaAddressGroups.Name
      description: Address group name
    - contextPath: PanoramaAddressGroups.Type
      description: Address group type
    - contextPath: PanoramaAddressGroups.Filter
      description: Address group filter
    - contextPath: PanoramaAddressGroups.Description
      description: Address group description
    - contextPath: PanoramaAddressGroups.Tag
      description: Address group tag
    description: Create an address group
  - name: panorama-delete-address-group
    arguments:
    - name: name
      description: Address group name
    description: Delete an address group
  - name: panorama-block-address-group
    arguments:
    - name: address_group_name
      required: true
      description: Address group name
    - name: direction
      description: Direction to block
      defaultValue: to, from, both
    - name: rulename
      description: Rule name
    outputs:
    - contextPath: PanoramaRule.Name
      description: Rule name
    - contextPath: PanoramaRule.AddressGroupName
      description: Rule address group name
    - contextPath: PanoramaRule.Direction
      description: Rule direction
    description: Blocks an address group
  runonce: false
releaseNotes: "test"
tests:
- panorama_test_pb