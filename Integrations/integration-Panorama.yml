commonfields:
  id: Panorama
  version: -1
name: Panorama
fromversion: 3.0.0
display: Palo Alto Panorama
category: Network Security
image: data:image/png;base64,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
description: Manage Palo Alto Networks firewalls via the Panorama management interface
detaileddescription: |-
  The integration uses the Panorama XML API.
  To obtain an API Key, use the following REST command:
  https://[PanoramaIP]/api/?type=keygen&user=[user]&password=[password]
  and copy the resulting key.
  For more information, visit: https://www.paloaltonetworks.com/documentation
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Port
  name: port
  defaultvalue: ""
  type: 0
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    ''' IMPORTS '''
    import string
    import requests
    import json
    import re
    import uuid

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    if not demisto.params().get("proxy", False):
        del os.environ["HTTP_PROXY"]
        del os.environ["HTTPS_PROXY"]
        del os.environ["http_proxy"]
        del os.environ["https_proxy"]

    ''' GLOBALS '''
    URL = demisto.params().get('server').rstrip('/:') + ':' + demisto.params().get('port') + '/api/'
    API_KEY = str(demisto.params().get('key'));
    USE_SSL = not demisto.params()['insecure']
    #HEADERS = {'Content-Type': 'application/x-www-form-urlencoded'}

    ''' HELPERS '''
    def http_request(uri, method, headers = {}, body = {}, params={}, files={}):
        ''' Makes an API call with the gicen arguments '''
        #demisto.log(uri)
        #demisto.log('11111')
        #demisto.log(method)
        #demisto.log(str(headers))
        #demisto.log('22222')
        #demisto.log(str(body))
        #demisto.log(str(params))
        #demisto.log(str(USE_SSL))
        #sys.exit(0)

        result = requests.request(
            method,
            uri,
            headers=headers,
            data=body,
            verify=USE_SSL,
            params=params,
            files=files
        )
        if result.status_code < 200 or result.status_code >= 300:
            return_error('Request Failed.\nStatus code: ' + str(result.status_code) + ' with body ' + result.content + ' with headers ' + str(result.headers))

        jresult = json.loads(xml2json(result.text))
        if jresult['response']['@status'] != 'success':
            return_error('Request Failed.\nStatus code: ' + j_result.response['-code'] + '\nBody: ' + result.Body)

        return jresult

    def add_argument_open(arg, field_name, member):
        if arg:
            if member:
                return '<' + field_name + '><member>' + arg + '</member></' + field_name + '>'
            else:
                return '<' + field_name + '>' + arg + '</' + field_name + '>'
        else:
            return ''

    def add_argument_yes_no(arg, field_name):
        if arg:
            return '<' + field_name + '>' + ('yes' if arg else 'no') + '</' + field_name + '>'
        else:
            return ''

    def prepare_params(xpath = None, rulename = None, src_ip = None, dst_ip = None,
                    negate_src = None, negate_dst = None, action = None, service = None,
                    disable = None, application = None, src_user = None,
                    fromm = None, to = None, disable_server_response_inspection = None,
                    description = None):

        rulename = rulename if rulename else uuid.uuid4()
        params = {
            'type': 'config',
            'action': 'set',
            'key': API_KEY,
            'xpath': xpath if xpath else '/config/devices/entry/vsys/entry/rulebase/security/rules/entry[@name=\'' + rulename +'\']',
            'element':
                add_argument_open(action, 'action', False) +
                add_argument_open(description, 'description', False) +
                add_argument_open(src_ip, 'source', True) +
                add_argument_open(dst_ip, 'destination', True) +
                add_argument_open(application, 'application', True) +
                add_argument_open(src_user, 'source-user', True) +
                add_argument_open(fromm, 'from', True) +
                add_argument_open(to, 'to', True) +
                add_argument_open(service, 'service', True) +
                add_argument_yes_no(negate_src, 'negate-source') +
                add_argument_yes_no(negate_dst, 'negate-destination') +
                add_argument_yes_no(disable, 'disabled') +
                add_argument_yes_no(disable_server_response_inspection, 'disable-server-response-inspection')
        }
        return params

    ''' FUNCTIONS'''
    def panorama_test():
        ''' test module '''
        params = {
            'type':'op',
            'cmd': '<show><system><info></info></system></show>',
            'key': API_KEY
            }
        result = http_request(
            URL,
            'GET',
            params = params
            )
        demisto.results('ok')

    def panorama_dynamic_list():
        ''' Creates a dynamic list in panorama '''
        params = {
            'type':'user-id',
            'key': API_KEY
        }
        result = http_request(
            URL,
            'POST',
            params = params,
            files = demisto.args()['file'],
            )
        demisto.results(result['response']['@status'])

    def panorama_move():
        ''' Moves a rule'''
        params = {
            'type': 'config',
            'action': 'move',
            'key': API_KEY,
            'where': demisto.args()['where']
        }

        if 'xpath' in demisto.args():
            params['xpath'] = demisto.args()['xpath']
        else:
            params['xpath'] = '/config/devices/entry/vsys/entry/rulebase/security/rules/entry[@name=\'' + demisto.args()['src'] + '\']'

        if 'dst' in demiso.args():
            params['dst'] = demisto.args()['dst']

        result = http_request(URL, 'POST', params = params)
        demisto.results(result['response']['@status'])

    def panorama_block_ip():
        ip = demisto.args()['ip']
        direction = demisto.args()['direction'] if 'direction' in demisto.args() else 'both'
        rule_name =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())

        block_destination = False if direction == 'from' else True
        block_source =  False if direction == 'to' else True

        if block_source:
            params = prepare_params(action = 'drop', src_ip = ip, dst_ip = 'any', rulename = rule_name + '-from')
            result = http_request(URL, 'POST', params = params)

        if block_destination:
            params = prepare_params(action = 'drop', dst_ip = ip, src_ip = 'any', rulename = rule_name + '-to')
            result = http_request(URL, 'POST', params = params)

    def panorama_block_application():
        application = demisto.args()['application']
        rule_name =  demisto.args()['rulename'] if 'rulename' in demisto.args() else str(uuid.uuid4())
        params = prepare_params(action = 'drop', src_ip = 'any', dst_ip = 'any', rulename = rule_name, application = application)
        result = http_request(URL, 'POST', params = params)

    def panorama_command():
        ''' Executes a command in panorama'''
        params = {}
        params['key'] = API_KEY
        for arg in demisto.args().keys():
            params[arg] = demisto.args()[arg]

        result = http_request(
                URL,
                'POST',
                params=params
                )
        demisto.results(result['response']['@status'])

    def panorama_commit():
        ''' Commit panorama '''
        params = {
            'type': 'commit',
            'cmd': '<commit></commit>',
            'key': API_KEY
        }
        result = http_request(
            URL,
            'POST',
            params = params
            )
        demisto.results(result['response']['@status'])

    ''' EXECUTION '''
    LOG('command is %s' % (demisto.command(), ))

    try:
        if demisto.command() == 'test-module':
            panorama_test()

        elif demisto.command() == 'panorama-dynamic-block-list':
            panorama_dynamic_list()

        elif demisto.command() == 'panorama-move':
            panorama_move()

        elif demisto.command() == 'panorama-block-ip':
            panorama_block_ip()
            panorama_commit()

        elif demisto.command() == 'panorama-block-application':
            panorama_block_application()
            panorama_commit()

        elif demisto.command() == 'panorama-commit':
            panorama_commit()

        elif demisto.command() == 'panorama':
            panorama_command()


    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        return_error(e.message)
  type: python
  commands:
  - name: panorama
    arguments:
    - name: action
      description: Choose an available  actio(show,get,set,edit, delete,rename,clone,move,override)
    - name: category
      description: Category parameter. e.g. when exporting a configuration file use
        category=configuration
    - name: cmd
      description: Used for operations commands cmd specifies the xml struct that
        defines the command.
    - name: command
      description: Run a command. e.g. command =<show><arp><entry name='all'/></arp></show>
    - name: dst
      description: Specifies destination
    - name: element
      description: Used to define a new value for an object
    - name: to
      description: To parameter (used in specifying time and when cloning an object)
    - name: from
      description: From parameter (used in specifying time and when cloning an object)
    - name: key
      description: Sets a key value
    - name: log-type
      description: Used for retrieving logs. e.g. log-type=threat for threat logs
    - name: where
      description: Specifies the type of a move operation (e.g. where=after, where=before,
        where=top, where=bottom)
    - name: period
      description: Describe a time period. E.g. period=last-24-hrs
    - name: xpath
      description: Defines a location e.g. xpath=/config/predefined/application/entry[@name='hotmail']
    - name: pcap-id
      description: The threat pcap ID in the threat log
    - name: serialno
      description: Specifies the device serial number
    - name: reporttype
      description: Choose dynamic,predefined or custom report
    - name: reportname
      description: The report name
    - name: log-type
      description: Used for retrieving logs. e.g. log-type=threat for threat logs
    - name: type
      description: The request type (e.g. export, import, log, config)
    - name: search-time
      description: Used for threat PCAPs, the time that the PCAP was received on the
        firewall.
    description: Run any panorama command supported in api.
  - name: panorama-dynamic-block-list
    arguments:
    - name: file
      required: true
      description: The dynamic block list file. Can be created using PanoramaDynamicAddressGroup
        script
    description: Create a dynamic block list
  - name: panorama-move
    arguments:
    - name: xpath
      description: Usually not required as "src" is sufficient. Full XPath to the
        source rule to be moved.
    - name: src
      description: Source value for the request. For further information, see the
        Panorama XML API Documentation.
    - name: where
      required: true
      description: Values for the "where" parameter include "before", "after", "top"
        or "bottom". For further information, see the Panorama XML API Documentation.
    - name: dst
      description: Destination xpath to move the rule. For further information, see
        the Panorama XML API Documentation.
    description: Move panorama rules
  - name: panorama-block-ip
    arguments:
    - name: ip
      required: true
      description: IP to block
    - name: rulename
      description: Rule name
    - name: direction
      description: Direction to block
      defaultValue: to, from, both
    description: Blocks IP with Panorama
  - name: panorama-block-application
    arguments:
    - name: application
      required: true
      description: Application to block
    - name: rukename
      description: Rule name
    description: Blocks an application with Panorama
  runonce: false
releaseNotes: ""
tests:
- Not Yet
